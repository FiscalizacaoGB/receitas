<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Resumo de Linhas - Cidade Sol</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
}

/* HEADER */
header {
  background: #0b2545;
  padding: 10px 20px;
}
header img {
  height: 50px;
}

/* SECTION */
section {
  padding: 20px;
}

/* CONTROLS */
.controls {
  margin: 20px 0;
}
select, button {
  padding: 8px;
  margin-right: 10px;
}

/* CARDS */
.cards-resumo {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}
.card {
  background: #fff;
  border-left: 5px solid #0b2545;
  padding: 12px;
  border-radius: 8px;
}
.card span.label {
  display: block;
  font-size: 12px;
  color: #6b7280;
}
.card span.valor {
  font-size: 18px;
  font-weight: bold;
  color: #0b2545;
}

/* TABLE */
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 14px;
  text-align: center;
}
th {
  background: #eee;
}

.positivo { color: green; font-weight: bold; }
.negativo { color: red; font-weight: bold; }

/* MOBILE */
@media (max-width: 768px) {
  .cards-resumo {
    grid-template-columns: 1fr 1fr;
  }
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
}
@media (max-width: 480px) {
  .cards-resumo {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<header>
  <img src="logo.png" alt="Cidade Sol">
</header>

<section>
<h2>Resumo de Linhas</h2>

<!-- CARDS -->
<div class="cards-resumo">
  <div class="card" id="cardTarifaBox">
    <span class="label">Tarifa Total</span>
    <span class="valor" id="cardTarifa">R$ 0,00</span>
  </div>

  <div class="card" id="cardSeguroBox">
    <span class="label">Seguro Total</span>
    <span class="valor" id="cardSeguro">R$ 0,00</span>
  </div>

  <div class="card">
    <span class="label">Receita Total</span>
    <span class="valor" id="cardReceita">R$ 0,00</span>
  </div>

  <div class="card">
    <span class="label">KM Rodado</span>
    <span class="valor" id="cardKm">0</span>
  </div>

  <div class="card">
    <span class="label">Pax</span>
    <span class="valor" id="cardPax">0</span>
  </div>

  <div class="card">
    <span class="label">R$/KM Médio</span>
    <span class="valor" id="cardRkm">0,00</span>
  </div>
</div>

<!-- FILTROS -->
<div class="controls">
  <select id="ano">
    <option value="">Ano</option>
    <option value="2024">2024</option>
    <option value="2025">2025</option>
    <option value="2026">2026</option>
  </select>

  <select id="mes">
    <option value="">Mês</option>
    <option value="1">Janeiro</option>
    <option value="2">Fevereiro</option>
    <option value="3">Março</option>
    <option value="4">Abril</option>
    <option value="5">Maio</option>
    <option value="6">Junho</option>
    <option value="7">Julho</option>
    <option value="8">Agosto</option>
    <option value="9">Setembro</option>
    <option value="10">Outubro</option>
    <option value="11">Novembro</option>
    <option value="12">Dezembro</option>
  </select>

  <select id="grupo">
    <option value="todos">Todos</option>
    <option>Grupo Alagoinhas</option>
    <option>Grupo Recôncavo</option>
    <option>Grupo Regional</option>
  </select>

  <label>
    <input type="checkbox" id="somarSeguro">
    Tarifa + Seguro
  </label>

  <button onclick="buscarLinhas()">Buscar</button>
</div>

<!-- TABELA -->
<table>
<thead>
<tr>
  <th>Linha</th>
  <th>Receita</th>
  <th id="thSeguro">Seguro</th>
  <th>KM</th>
  <th>Pax</th>
  <th>R$/KM</th>
  <th>Δ R$/KM</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</section>

  <script>
/* ===== SEGURANÇA / AUTENTICAÇÃO ===== */
const AUTH_API = "https://script.google.com/macros/s/AKfycbwhOf-cQ-b8lyt60kfrYlfDjvafphoWxmRgIUiuZAI28oZbojv5LHjttmprTNMlq1RG/exec";

const token = sessionStorage.getItem("token");
if (!token) {
  window.location.href = "login.html";
}

fetch(AUTH_API, {
  method: "POST",
  body: JSON.stringify({ token })
})
.then(r => r.json())
.then(d => {
  if (d.status !== "ok") {
    sessionStorage.clear();
    window.location.href = "login.html";
  }
})
.catch(() => {
  sessionStorage.clear();
  window.location.href = "login.html";
});
</script>

<script>
const URL_LINHAS =
"https://script.google.com/macros/s/AKfycbx_fKvxZ3N0BcMcpa-U26D4csvOD2nI9ExvswodJwjSv2k5PR269jNvAwgjbBd28_h7RQ/exec";

function moeda(v) {
  return Number(v).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function decimal(v){
  return Number(v).toLocaleString("pt-BR",{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  });
}
function soma(arr,campo){
  return arr.reduce((t,i)=>t+(Number(i[campo])||0),0);
}

async function buscarLinhas(){
  const ano = Number(document.getElementById("ano").value);
  const mes = Number(document.getElementById("mes").value);
  const grupo = document.getElementById("grupo").value;
  const somarSeguro = document.getElementById("somarSeguro").checked;
  const thSeguro = document.getElementById("thSeguro");
  const tbody = document.getElementById("tbody");

  if(!ano||!mes){
    alert("Selecione ano e mês");
    return;
  }

  tbody.innerHTML = "<tr><td colspan='7'>Carregando...</td></tr>";

  const res = await fetch(URL_LINHAS);
  const dados = await res.json();

  const atual = dados.filter(l =>
    l.Ano === ano &&
    l.Mês === mes &&
    (grupo === "todos" || l.Grupo === grupo)
  );

  /* ===== SOMATÓRIOS ===== */
  const totalTarifa = soma(atual,"Tarifa");
  const totalSeguro = soma(atual,"Seguro");
  const receitaTotal = totalTarifa + totalSeguro;
  const totalKm = soma(atual,"Km_Rodado");
  const totalPax = soma(atual,"Qtd_Pax");
  const rkmMedio = totalKm ? receitaTotal / totalKm : 0;

  /* ===== CONTROLE DE VISIBILIDADE ===== */
  document.getElementById("cardTarifaBox").style.display =
    somarSeguro ? "none" : "block";
  document.getElementById("cardSeguroBox").style.display =
    somarSeguro ? "none" : "block";
  thSeguro.style.display = somarSeguro ? "none" : "table-cell";

  /* ===== ATUALIZA CARDS ===== */
  cardTarifa.innerText = moeda(totalTarifa);
  cardSeguro.innerText = moeda(totalSeguro);
  cardReceita.innerText = moeda(receitaTotal);
  cardKm.innerText = decimal(totalKm);
  cardPax.innerText = decimal(totalPax);
  cardRkm.innerText = decimal(rkmMedio);

  /* ===== TABELA ===== */
  tbody.innerHTML = "";

  atual.forEach(l => {
    const ant = dados.find(a =>
      a.Linha === l.Linha &&
      a.Ano === ano - 1 &&
      a.Mês === mes
    );

    const diff = ant
      ? ((l["R$/KM"] - ant["R$/KM"]) / ant["R$/KM"]) * 100
      : null;

    const receitaLinha = somarSeguro
      ? (Number(l.Tarifa) + Number(l.Seguro))
      : Number(l.Tarifa);

    tbody.innerHTML += `
<tr>
  <td>${l.Linha}</td>
  <td>${moeda(receitaLinha)}</td>
  ${somarSeguro ? "" : `<td>${moeda(l.Seguro)}</td>`}
  <td>${decimal(l.Km_Rodado)}</td>
  <td>${decimal(l.Qtd_Pax)}</td>
  <td>${decimal(l["R$/KM"])}</td>
  <td class="${diff === null ? "" : diff >= 0 ? "positivo" : "negativo"}">
    ${diff === null ? "-" : diff.toFixed(2) + "%"}
  </td>
</tr>`;
  });
}
</script>

</body>
</html>
